---
title: "PORT: descriptives"
author: "Thomas McGregor"
date: "`r Sys.Date()`"
output: html_document
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "../reports"
    )
  })
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load packages, include=FALSE}
# Clear workspace
rm(list = ls())

# Load packages
library(broom) # tidying output
library(gt) # creating tables
library(gtsummary) # creating tables
library(here) # file referencing
library(naniar) # visualise missing data
library(ppcor) # partial correlations
library(summarytools) # data exploration
library(tidyverse) # data manipulation
library(webshot) # required for saving gt tables
```

```{r read in dataset, include=FALSE}
port_data <- read_rds(here("data", "processed", "merged", "07_imputed-processed-data.Rds"))
```

# Cleaning

## Subsets

```{r create subsets}
# Exclusions applied: all variables, filtered participants
port_data_exclusions_applied <- port_data %>% 
  filter(port_exclusion == FALSE)

# Subsetted: selected variables, filtered participants
port_data_subsetted <- port_data %>% 
  filter(port_exclusion == FALSE) %>% 
  dplyr::select(
    ieso_treatment_completed_total,
    demographics_age_at_screening_years,
    demographics_biological_sex,
    gad7_treatment_total_1,
    gad7_treatment_total_final,
    gad7_treatment_total_final_observed,
    gad7_followup_total,
    exp_acquisition_cs_minus_mean,
    exp_extinction_cs_plus_mean,
    fss_baseline_total,
    fss_followup_total)

# Subsetted, complete cases: selected variables, filtered participants, no missing data
port_data_subsetted_complete_cases <- na.omit(port_data_subsetted)
```

# Demographics

```{r demographics table}
demographics_data <-
  port_data_exclusions_applied %>%
  
  mutate(
    # Create followup change variable
    gad7_followup_change =
           gad7_followup_total - gad7_treatment_total_final,
    
    # Capitalise categories for sex variable
    demographics_biological_sex =
      factor(case_match(demographics_biological_sex,
                        "female" ~ "Female",
                        "male" ~ "Male"))) %>%
  
  # Select variables
  select(
    demographics_age_at_screening_years,
    demographics_biological_sex,
    ieso_treatment_completed_total,
    gad7_baseline_total,
    gad7_treatment_change_observed,
    gad7_followup_change
  )

# Create gt summary table
demographics_table <-
  demographics_data %>%
  tbl_summary(
    
    label = list(
      demographics_age_at_screening_years ~ "Age (years)",
      demographics_biological_sex ~ "Sex assigned at birth",
      ieso_treatment_completed_total ~ "Treatment sessions completed",
      gad7_baseline_total ~ "GAD-7 baseline",
      gad7_treatment_change_observed ~ "GAD-7 treatment change",
      gad7_followup_change ~ "GAD-7 follow-up change"
    ),
    
    statistic = list(
      demographics_age_at_screening_years ~ "{mean} ({sd})",
      ieso_treatment_completed_total ~ "{mean} ({sd})",
      gad7_baseline_total ~ "{mean} ({sd})",
      gad7_treatment_change_observed ~ "{mean} ({sd})",
      gad7_followup_change ~ "{mean} ({sd})"
    ),
    
    digits = list(
      demographics_age_at_screening_years ~ 2,
      demographics_biological_sex ~ 0,
      ieso_treatment_completed_total ~ 2,
      gad7_baseline_total ~ 2,
      gad7_treatment_change_observed ~ 2,
      gad7_followup_change ~ 2
    ),
    
    missing_text = "Missing"
    
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>%
  as_gt() %>%
  gt::tab_options(table.font.names = "Arial",
                  table.font.size = 11)

# Print demographics display table
demographics_table

# Save table
gtsave(demographics_table, 
       filename = here("reports", "tables", "demographics_table.png"),
       expand = 10)
```

# Diagnoses and treatment pathways

```{r}
port_data_exclusions_applied %>% 
  group_by(ieso_diagnosis_name) %>% 
  count() %>% 
  arrange(desc(n))


port_data_exclusions_applied %>% 
  group_by(ieso_protocol_token) %>%
  count() %>% 
  arrange(desc(n))
```

# IAPT categories

```{r}
port_data_exclusions_applied %>% 
  select(iapt_reliable_improvement_observed, iapt_recovery_observed, iapt_rcsi_observed) %>% 
  na.omit %>% 
  ggplot(aes(x = iapt_reliable_improvement_observed, fill = fct_rev(as.character(iapt_recovery_observed)))) +
  geom_bar() +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank()) +
  scale_fill_manual(values = c("#811D1C", "#153860"))
```

## Fear conditioning
```{r}
port_data_exclusions_applied %>% 
  group_by(iapt_rcsi_observed) %>% 
  summarise(n = n(),
            mean_acq_plus = mean(exp_acquisition_cs_plus_mean, na.rm = TRUE),
            mean_acq_minus = mean(exp_acquisition_cs_minus_mean, na.rm = TRUE),
            mean_ext_plus = mean(exp_extinction_cs_plus_mean, na.rm = TRUE),
            mean_ext_minus = mean(exp_extinction_cs_minus_mean, na.rm = TRUE))
```

# Symptom trajectories

```{r}
data_viz_transformed <- port_data_exclusions_applied %>%
  select(
    participant_id,
    gad7_assessment_total,
    matches("gad7_treatment_total_\\d*$"),
    phq9_assessment_total,
    matches("phq9_treatment_total_\\d*$")
  ) %>%
  pivot_longer(
    cols = c(
      gad7_assessment_total,
      matches("gad7_treatment_total_\\d*$"),
      phq9_assessment_total,
      matches("phq9_treatment_total_\\d*$")
    ),
    names_to = "session",
    values_to = "score"
  ) %>%
  mutate(
    session = case_when(
      session == "gad7_assessment_total" ~ "gad7_treatment_total_0",
      session == "phq9_assessment_total" ~ "phq9_treatment_total_0",
      TRUE ~ session
    )
  ) %>%
  separate_wider_delim(
    session,
    names = c("measure", "type", "x", "session"),
    delim = "_"
  ) %>%
  select(-c(type, x)) %>%
  mutate(session = as.numeric(session)) %>% 
  group_by(measure, session) %>%
  summarise(across(
    .cols = score,
    .fns = list(
      mean = ~ mean(.x, na.rm = TRUE),
      sd = ~ sd(.x, na.rm = TRUE),
      sample_size = ~ sum(!is.na(.x))
    ),
    .names = "{.fn}"
  )) %>%
  ungroup() %>%
  mutate(
    se = sd / sqrt(sample_size),
    se_lower = mean - se,
    se_upper = mean + se
  )

data_viz_transformed %>%
  filter(session < 12,
         measure == "gad7") %>%
  ggplot(., aes(x = session, y = mean, color = measure)) +
  geom_point() +
  geom_line() +
  geom_ribbon(
    aes(ymin = se_lower, ymax = se_upper, fill = measure),
    alpha = 0.1,
    linetype = 0
  ) +
  theme_minimal() +
  geom_text(aes(label = sample_size), nudge_y = 1, size = 3) +
  scale_x_continuous(breaks = seq(0, 11, by = 1)) +
  scale_y_continuous(limits = c(0, 21), breaks = seq(0, 21, by = 3)) +
  labs(title = "Average GAD-7 score over the course of treatment",
       x = "Treatment session",
       y = "Average GAD-7 score",
       caption = "Number above each point indicates sample size") +
  scale_color_manual(values = "#153860") +
  scale_fill_manual(values = "#153860") +
  theme(legend.position = "none",
        panel.grid.minor = element_blank())

ggsave(here("reports", "figures", "symptom-trajectory.png"),
  bg = "white")
```

# Interpretation biases