---
title: "PORT: preliminary analyses"
author: "Thomas McGregor"
date: "`r Sys.Date()`"
output: html_document
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "../reports"
    )
  })
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load packages, include=FALSE}
# Clear workspace
rm(list = ls())

# Load packages
library(broom) # tidying output
library(gt) # creating tables
library(here) # file referencing
library(naniar) # visualise missing data
library(ppcor) # partial correlations
library(summarytools) # data exploration
library(tidyverse) # data manipulation
library(webshot) # required for saving gt tables
```

```{r read in dataset, include=FALSE}
port_data <- read_rds(here("data", "processed", "merged", "07_imputed-processed-data.Rds"))

port_data_exclusions_applied <- port_data %>% 
  filter(port_exclusion != TRUE)
```

# Cleaning

## Subsets
```{r}
# Exclusions applied: all variables, filtered participants
port_data_exclusions_applied <- port_data %>% 
  filter(port_exclusion != TRUE)

# Subsetted: selected variables, filtered participants
port_data_subsetted <- port_data %>% 
  filter(port_exclusion == FALSE) %>% 
  dplyr::select(
    ieso_treatment_completed_total,
    demographics_age_at_screening,
    demographics_biological_sex,
    gad7_treatment_total_1,
    gad7_treatment_total_final,
    gad7_treatment_total_final_observed,
    gad7_followup_total,
    exp_acquisition_cs_minus_mean,
    exp_extinction_cs_plus_mean,
    fss_baseline_total,
    fss_followup_total)

# Subsetted, complete cases: selected variables, filtered participants, no missing data
port_data_subsetted_complete_cases <- na.omit(port_data_subsetted)
```

## Standardising

```{r}
port_data_exclusions_applied_std <- port_data_exclusions_applied %>% 
  mutate(across(
    .cols = c(
      exp_acquisition_cs_minus_mean,
      exp_extinction_cs_plus_mean,
      gad7_treatment_total_1 + 
      ieso_treatment_completed_total,
      demographics_age_at_screening,
      demographics_biological_sex,
      fss_baseline_total
    )
  ))
```


# Demographics
```{r}
demographics_data <- 
  port_data_exclusions_applied %>%
  
  # Rename and subset variables
  dplyr::select(age = demographics_age_at_screening,
                sex = demographics_biological_sex,
                n_sessions = ieso_treatment_completed_total,
                gad7_baseline = gad7_baseline_total,
                gad7_change = gad7_treatment_change_observed) %>%
  group_by(sex) %>%
  
  # Generate summary table
  summarise(
    n = n(),
    mean_age = mean(age, na.rm = TRUE),
    mean_gad7 = mean(gad7_baseline, na.rm = TRUE),
    mean_gad7_change = mean(gad7_change, na.rm = TRUE),
    median_sessions = median(n_sessions, na.rm = TRUE)
  ) %>%
  
  # Reshape data so that data is long with male/female columns
  pivot_longer(cols = -sex, names_to = "variable", values_to = "value") %>% 
  pivot_wider(names_from = "sex", values_from = "value") %>%
  
  # Rename values in variable column
  mutate(variable = recode(variable,
                           n = "n",
                           mean_age = "Mean age",
                           mean_gad7 = "Mean GAD-7 study baseline",
                           mean_gad7_change = "Mean GAD-7 change",
                           median_sessions = "Median number of sessions")) 

demographics_data %>% 
  
  # Create display table from data
  gt() %>%  
  cols_label(
    variable = "",
    female = md("**Female**"),
    male = md("**Male**")
  ) %>% 
  tab_header(title = "PORT Study Demographics") %>% 
  fmt_number(columns = where(is.numeric),
             decimals = 2) %>% 
  tab_options(table.font.size = px(11)) %>%
  opt_table_font(
    font = list(
      google_font(name = "Merriweather"),
      "Cochin", "Serif"
    )
  ) %>% 
  
  # Format n and median rows to have 1 decimal place 
  fmt(columns = c(female, male),
      rows = which(variable %in% c("n", "Median number of sessions")), 
      fns = function(x) { 
        formatC(as.numeric(x), digits = 0, format = "f")
      } )
```


# Explore

## Visualise missing data
```{r}
port_data_subsetted %>%  
vis_miss()
```

## Skew & kurtosis
```{r}
descr(port_data_subsetted)
```

## Correlations

### Acquisition CS- x GAD-7 at last session
```{r}
# Partial correlation
pcor.test(
  port_data_subsetted_complete_cases$gad7_treatment_total_final_observed,
  port_data_subsetted_complete_cases$exp_acquisition_cs_minus_mean,
  port_data_subsetted_complete_cases$gad7_treatment_total_1,
  method="pearson"
)

# Scatterplot
port_data_subsetted %>% 
  ggplot(aes(x = exp_acquisition_cs_minus_mean, y = gad7_treatment_total_final_observed)) +
  geom_point() + 
  geom_smooth(method=lm)
```

### Extinction CS+ x GAD-7 at last session

```{r}
# Partial correlation
pcor.test(
  port_data_subsetted_complete_cases$gad7_treatment_total_final_observed,
  port_data_subsetted_complete_cases$exp_extinction_cs_plus_mean,
  port_data_subsetted_complete_cases$gad7_treatment_total_1,
  method="pearson"
)

# Scatterplot
port_data_subsetted %>% 
  ggplot(aes(x = exp_extinction_cs_plus_mean, y = gad7_treatment_total_final_observed)) +
  geom_point() + 
  geom_smooth(method=lm)
```

# Analyses

## Primary - GAD-7 at last session

### Acquisition CS-

```{r}
# Generate model
pri_acq_minus_model <- 
  port_data_subsetted %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_acquisition_cs_minus_mean + 
      gad7_treatment_total_1 + 
      ieso_treatment_completed_total,
    data = .
  )

# Model output
summary(pri_acq_minus_model)

# Save single row summary of model
pri_acq_minus_model_glance <- 
  glance(pri_acq_minus_model)

# Save summary data.frame of test results
pri_acq_minus_model_tidy <- 
  tidy(pri_acq_minus_model, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 4)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "primary", 
         model = "acquisition_cs_minus", 
         .before = everything())
```

### Extinction CS+

```{r}
# Generate model
pri_ext_plus_model <- 
  port_data_subsetted %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_extinction_cs_plus_mean + 
      gad7_treatment_total_1 + 
      ieso_treatment_completed_total,
    data = .
  )

# Model output
summary(pri_ext_plus_model)

# Save single row summary of model
pri_ext_plus_model_glance <- 
  glance(pri_ext_plus_model)

# Save summary data.frame of test results
pri_ext_plus_model_tidy <- 
  tidy(pri_ext_plus_model, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 4)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "primary", 
         model = "extinction_cs_plus", 
         .before = everything())
```

### Combined
```{r}
primary_models_tidy <- rbind(pri_acq_minus_model_tidy, pri_ext_plus_model_tidy) %>% 
  mutate(sig_05 = if_else(p.value < 0.05, TRUE, FALSE),
         sig_05_adj = if_else(pval.adj < 0.05, TRUE, FALSE),
         term = factor(if_else(str_detect(term, "exp_"), "fc", term)),
         iv = case_when(
           term == "gad7_treatment_total_1" ~ FALSE,
           term == "ieso_treatment_completed_total" ~ FALSE,
           TRUE ~ TRUE))

primary_models_tidy
```

```{r}
primary_models_tidy %>%
  filter(term != "(Intercept)") %>% 
  
  # Plot
  ggplot(aes(
    x = estimate,
    y = fct_rev(term),
    group = fct_rev(model),
    colour = model,
    alpha = iv
  )) +
  geom_point(aes(shape = sig_05_adj),
             size = 2,
             position = position_dodge(width = .2)) +
  
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high),
                position = position_dodge(width = .2),
                width = 0) +
  
  # Colour/shape settings
  scale_color_manual(values = c("#811D1C", "#153860")) +
  scale_shape_manual(values = c(1, 16)) +
  scale_alpha_discrete(range=c(0.4, 1)) +
  
  # Labels
  scale_y_discrete(
    labels = c(
      "ieso_treatment_completed_total" = "Number of treatment sessions",
      "gad7_treatment_total_1" = "First session GAD-7 score",
      "fc" = "Fear conditioning predictor",
      "(Intercept)" = "Intercept"
    )
  ) +
  labs(title = "Associations between GAD-7 scores and expectancy ratings",
       caption = paste0("Acquisition CS- model intercept = ", 
                        round(pri_acq_minus_model$coefficients[1], digits = 2),
                        "\nExtinction CS+ model intercept = ", 
                        round(pri_ext_plus_model$coefficients[1], digits = 2)),
       x = "Beta coefficient estimate",
       y = element_blank()) +
  
  # Theme
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.text.x = element_blank()
  )

ggsave(here("reports", "figures", "primary-regression-forest-plot.pdf"))
```

## Secondary

### Age/Sex adjustment

#### Acquisition CS-

```{r}
pri_acq_minus_model <- port_data_subsetted %>% 
  lm(
    gad7_treatment_total_final_observed ~ exp_acquisition_cs_minus_mean + gad7_treatment_total_1 + ieso_treatment_completed_total + demographics_age_at_screening +
    demographics_biological_sex, 
    data = .
  )

```

#### Extinction CS+

```{r}
extinction_cs_plus_model <- port_data_subsetted %>% 
  lm(gad7_treatment_total_final_observed ~ exp_extinction_cs_plus_mean + gad7_treatment_total_1 + ieso_treatment_completed_total + demographics_age_at_screening +
    demographics_biological_sex, data = .)

summary(extinction_cs_plus_model)

pcor.test(port_data_subsetted_complete_cases$gad7_treatment_total_final_observed,
          port_data_subsetted_complete_cases$exp_extinction_cs_plus_mean,
          port_data_subsetted_complete_cases$gad7_treatment_total_1,
          method="pearson")

port_data_subsetted %>% 
  ggplot(aes(x = exp_extinction_cs_plus_mean, y = gad7_treatment_total_final_observed)) +
  geom_point() + 
  geom_smooth(method=lm)
```

### GAD-7 at follow-up (DV)

#### Acquisition CS-

```{r}
pri_acq_minus_model <- port_data_subsetted %>% 
  lm(
    gad7_followup_total ~ exp_acquisition_cs_minus_mean + gad7_treatment_total_1 + ieso_treatment_completed_total, 
    data = .
  )

summary(pri_acq_minus_model)

pcor.test(
  port_data_subsetted_complete_cases$gad7_followup_total,
  port_data_subsetted_complete_cases$exp_acquisition_cs_minus_mean,
  port_data_subsetted_complete_cases$gad7_treatment_total_1,
  method="pearson"
)

port_data_subsetted %>% 
  ggplot(aes(x = exp_acquisition_cs_minus_mean, y = gad7_followup_total)) +
  geom_point() + 
  geom_smooth(method=lm)
```

#### Extinction CS+

```{r}
extinction_cs_plus_model <- port_data_subsetted %>% 
  lm(gad7_followup_total ~ exp_extinction_cs_plus_mean + gad7_treatment_total_1 + ieso_treatment_completed_total, data = .)

summary(extinction_cs_plus_model)

pcor.test(port_data_subsetted_complete_cases$gad7_followup_total,
          port_data_subsetted_complete_cases$exp_extinction_cs_plus_mean,
          port_data_subsetted_complete_cases$gad7_treatment_total_1,
          method="pearson")

port_data_subsetted %>% 
  ggplot(aes(x = exp_extinction_cs_plus_mean, y = gad7_followup_total)) +
  geom_point() + 
  geom_smooth(method=lm)
```

### FSS scores at follow-up

```{r}
fss_model <- port_data_subsetted %>% 
  lm(fss_followup_total ~ exp_extinction_cs_plus_mean + fss_baseline_total + ieso_treatment_completed_total, data = .)

summary(fss_model)

pcor.test(port_data_subsetted_complete_cases$fss_followup_total,
          port_data_subsetted_complete_cases$exp_extinction_cs_plus_mean,
          port_data_subsetted_complete_cases$fss_baseline_total,
          method="pearson")

port_data_subsetted %>% 
  ggplot(aes(x = exp_extinction_cs_plus_mean, y = fss_followup_total)) +
  geom_point() + 
  geom_smooth(method=lm)
```

## Exploratory

### Discrimination scores (IV)

### Affective ratings (IV)

### Non-fear conditioning (IVs)

### Depression (covariate)

### Low GAD-7 excluded

### Non-completers excluded

# Visualisation

## Symptom trajectories
```{r}
data_viz_transformed <- port_data_exclusions_applied %>%
  select(
    participant_id,
    gad7_assessment_total,
    matches("gad7_treatment_total_\\d*$"),
    phq9_assessment_total,
    matches("phq9_treatment_total_\\d*$")
  ) %>%
  pivot_longer(
    cols = c(
      gad7_assessment_total,
      matches("gad7_treatment_total_\\d*$"),
      phq9_assessment_total,
      matches("phq9_treatment_total_\\d*$")
    ),
    names_to = "session",
    values_to = "score"
  ) %>%
  mutate(
    session = case_when(
      session == "gad7_assessment_total" ~ "gad7_treatment_total_0",
      session == "phq9_assessment_total" ~ "phq9_treatment_total_0",
      TRUE ~ session
    )
  ) %>%
  separate(
    session,
    into = c("measure", "type", "x", "session"),
    sep = c("_", "_", "_"),
    convert = TRUE
  ) %>%
  select(-c(type, x)) %>%
  group_by(measure, session) %>%
  summarise(across(
    .cols = score,
    .fns = list(
      mean = ~ mean(.x, na.rm = TRUE),
      sd = ~ sd(.x, na.rm = TRUE),
      sample_size = ~ sum(!is.na(.x))
    ),
    .names = "{.fn}",
    .groups = "keep"
  )) %>%
  ungroup() %>%
  mutate(
    se = sd / sqrt(sample_size),
    se_lower = mean - se,
    se_upper = mean + se
  )

data_viz_transformed %>%
  filter(session < 12) %>%
  ggplot(., aes(x = session, y = mean, color = measure)) +
  geom_point() +
  geom_line() +
  geom_ribbon(
    aes(ymin = se_lower, ymax = se_upper, fill = measure),
    alpha = 0.1,
    linetype = 0
  ) +
  theme_minimal() +
  geom_text(aes(label = sample_size), nudge_y = .3, size = 3) +
  scale_x_continuous(breaks = seq(0, 11, by = 1)) +
  facet_wrap(~measure)
```

## Elephant

```{r Elephant wrangling, include=FALSE}
# Create a list of expectancy rating trial variables
elephant_long <- port_data_exclusions_applied %>% 
  select(matches("^exp_.*\\d$")) %>%
  mutate(n = nrow(.)) %>% 
  pivot_longer(cols = -n, names_to = "variable", values_to = "rating") %>% 
  mutate(variable = str_remove(variable, "exp_")) %>%
  separate(variable, into = c("phase", "cs", "stimulus", "trial"), sep = "_") %>% 
  select(-cs) %>% 
  mutate(trial = as.numeric(trial)) %>% 
  group_by(phase, stimulus, trial) %>% 
  summarise(mean = mean(rating, na.rm = T), std_dev = sd(rating, na.rm = T), n = mean(n), .groups = "keep") %>% 
  mutate(sem = std_dev / sqrt(n),
         ci_low = mean - 2*(sem),
         ci_high = mean + 2*(sem)) %>% 
  ungroup() %>% 
  mutate(Phase = str_to_sentence(phase),
         Phase = factor(Phase, levels = c("Acquisition", "Extinction")),
         Stimulus = factor(stimulus, levels = c("plus", "minus")),
         Stimulus = fct_recode(Stimulus, "CS+" = "plus", "CS-" = "minus")) %>% 
  select(Phase, Stimulus, Trial = trial, everything()) %>% 
  select(-c(phase, stimulus)) %>% 
  arrange(Phase, Stimulus, Trial)

# Function for breaks
breaks_fun <- function(x) {
  if (max(x) > 12) {
    seq(0, 18, 1)
  } else {
    seq(0, 12, 1)
  }
}
```

```{r}
elephant_plot_exclusions_applied <- elephant_long %>% 
  ggplot(aes(x = Trial, y = mean, color = Stimulus)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = ci_low, ymax = ci_high, fill = Stimulus),
              linetype = 0,
              alpha = 0.3,
              size = 0.8
  ) +
  scale_fill_manual(values = c("#DF3B57", "#5762D5")) +
  scale_colour_manual(values = c("#DF3B57", "#5762D5")) +
  facet_grid(~ Phase, 
               scales = "free_x",
               space = "free_x"
    ) +
    # adjust the labels
    labs(y="Mean expectancy rating", 
         x = "Trials"
    ) +
    theme(strip.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.position = 'bottom',
          text = element_text(size = 10),
          strip.text.x = element_text(size = 10)
    ) +
    scale_x_continuous(breaks = breaks_fun) +
    scale_y_continuous(breaks = seq(0, 10, by = 1), limits = c(1, 9))

# Save
ggsave(
  file = paste0(here("reports", "figures"), "/elephant-plot_exclusions-applied.png"), 
  plot = elephant_plot_exclusions_applied, 
  width = 16, 
  height = 8, 
  units = "cm"
  )
```
