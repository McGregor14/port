---
title: "PORT analyses"
author: "Thomas McGregor"
date: "`r Sys.Date()`"
output: html_document
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "../reports"
    )
  })
---

```{r setup, include=FALSE}
# Default to preventing code, but not the results from appearing in the finished 
# file
knitr::opts_chunk$set(echo = FALSE)
```

```{r load packages, include=FALSE}
# Clear workspace
rm(list = ls())

# Load packages
library(broom) # tidying output
library(gt) # creating tables
library(here) # file referencing
library(naniar) # visualise missing data
library(ppcor) # partial correlations
library(summarytools) # data exploration
library(tidyverse) # data manipulation
library(webshot) # required for saving gt tables

# Source function script
source(file = here("r", "functions.R"))
```

```{r read data, include=FALSE}
# Read in master dataset
port_data <- read_rds(here("data", "processed", "merged", "07_imputed-processed-data.Rds"))
```

```{r subset}
# Create subsets

# Exclusions applied: all variables, exclusions applied
port_data_exclusions_applied <- port_data %>% 
  filter(port_exclusion == FALSE)

# Subsetted: selected variables, exclusions applied
port_data_subsetted <- port_data %>% 
  filter(port_exclusion == FALSE) %>% 
  select(
    ieso_treatment_completed_total,
    demographics_age_at_screening_years,
    demographics_biological_sex,
    gad7_treatment_total_1,
    gad7_treatment_total_final,
    gad7_treatment_total_final_observed,
    gad7_followup_total,
    exp_acquisition_cs_minus_mean,
    exp_extinction_cs_plus_mean,
    fss_baseline_total,
    fss_followup_total)

# Subsetted, complete cases: selected variables, exclusions applied, no missing 
# data
port_data_subsetted_complete_cases <- na.omit(port_data_subsetted)
```

```{r standardising}
# Standardise (z-score) all continuous variables included in analyses
port_data_exclusions_applied_std <- 
  port_data_exclusions_applied %>%
  mutate(across(
    .cols = c(
      exp_acquisition_cs_minus_mean,
      exp_extinction_cs_plus_mean,
      gad7_treatment_total_1,
      ieso_treatment_completed_total,
      demographics_age_at_screening_years,
      fss_baseline_total,
      exp_acquisition_differential_mean,
      exp_extinction_differential_mean,
      aff_break_cs_plus_mean,
      aff_break_cs_minus_mean,
      aff_post_cs_plus_mean,
      aff_post_cs_minus_mean,
      cbas_baseline_total,
      eacs_midapp_total,
      asi_baseline_total,
      phq9_treatment_total_1
    ),
    .fns = ~ c(scale(.x, scale = TRUE, center = TRUE)),
    .names = "{col}_z"
  ))
```

# Explore {.tabset}

## Visualise missing data

-   Should not be any missing data for variables derived from GLAD (i.e. age at screening & biological sex)
-   Same goes for fear conditioning variables as missing data should be imputed (i.e. acquisition CS- and extinction CS+)

```{r visualise missing data, warning=FALSE}
port_data_subsetted %>%  
vis_miss()
```

## Skew & kurtosis

Skewness and Kurtosis values all range between +/- 1.

```{r describe data}
port_data_subsetted %>% 
  # Remove non-numerical variables to avoid warnings
  select(-demographics_biological_sex) %>% 
  descr()
```

## Correlations

### Acquisition CS- x GAD-7 at last session {.tabset}

#### Partial correlation

```{r acq correlation gad7}
# Partial correlation
partial_correlation <- pcor.test(
  port_data_subsetted_complete_cases$gad7_treatment_total_final_observed,
  port_data_subsetted_complete_cases$exp_acquisition_cs_minus_mean,
  port_data_subsetted_complete_cases$gad7_treatment_total_1,
  method="pearson"
)

print(partial_correlation)
```

#### Scatterplot

```{r acq scatterplot gad7}
# Scatterplot
port_data_subsetted %>% 
  ggplot(aes(x = exp_acquisition_cs_minus_mean, y = gad7_treatment_total_final_observed)) +
  geom_point() + 
  geom_smooth(formula = y ~ x, method = "lm")
```

### Extinction CS+ x GAD-7 at last session {.tabset}

#### Partial correlation

```{r ext correlation gad7}
# Partial correlation
pcor.test(
  port_data_subsetted_complete_cases$gad7_treatment_total_final_observed,
  port_data_subsetted_complete_cases$exp_extinction_cs_plus_mean,
  port_data_subsetted_complete_cases$gad7_treatment_total_1,
  method="pearson"
)
```

#### Scatterplot

```{r ext scatterplot gad7}
# Scatterplot
port_data_subsetted %>% 
  ggplot(aes(x = exp_extinction_cs_plus_mean, y = gad7_treatment_total_final_observed)) +
  geom_point() + 
  geom_smooth(formula = y ~ x, method = "lm")
```

# Analyses {.tabset}

## Primary

### GAD-7 at last session {.tabset}

Primary analyses use fear conditioning expectancy ratings to predict last session GAD-7 scores while controlling for first session GAD-7 score and number of treatment sessions completed.

#### Acquisition CS-

```{r primary acq}
# Generate model
pri_acq_minus_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_acquisition_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(pri_acq_minus_model)

# Save single row summary of model
pri_acq_minus_model_glance <- 
  glance(pri_acq_minus_model)

# Save summary dataframe of test results
pri_acq_minus_model_tidy <- 
  tidy(pri_acq_minus_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "primary", 
         model = "acquisition_cs_minus", 
         .before = everything())
```

#### Extinction CS+

```{r primary ext}
# Generate model
pri_ext_plus_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_extinction_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(pri_ext_plus_model)

# Save single row summary of model
pri_ext_plus_model_glance <- 
  glance(pri_ext_plus_model)

# Save summary dataframe of test results
pri_ext_plus_model_tidy <- 
  tidy(pri_ext_plus_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "primary", 
         model = "extinction_cs_plus", 
         .before = everything())
```

#### Combine

```{r primary combine dataframes}
# Combine tidied dataframes for potential plotting and tables
primary_models_tidy <-
  rbind(pri_acq_minus_model_tidy, pri_ext_plus_model_tidy) 

# Create a dataframe including only fear conditioning predictors
primary_models_tidy_fc <- 
  primary_models_tidy %>% 
  filter(str_detect(term, "exp_")) %>% 
  # Apply Holm Bonferonni correction
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 2))

# Do the same for non-fc predictors
primary_models_tidy_non_fc <- 
  primary_models_tidy %>% 
  filter(!str_detect(term, "exp_")) %>% 
  # Set corrected p values to missing
  mutate(pval.adj = NA)

# Bind dataframes back together
primary_models_tidy <-
  rbind(primary_models_tidy_fc, primary_models_tidy_non_fc) %>%
  # Add significance and IV flags
  mutate(
    sig_05 = factor(if_else(p.value < 0.05, TRUE, FALSE), levels = c("FALSE", "TRUE")),
    sig_05_adj = factor(if_else(pval.adj < 0.05, TRUE, FALSE), levels = c("FALSE", "TRUE")),
    iv = case_when(
      term == "(Intercept)" ~ FALSE,
      term == "gad7_treatment_total_1_z" ~ FALSE,
      term == "ieso_treatment_completed_total_z" ~ FALSE,
      TRUE ~ TRUE
    ),
    term = fct_rev(term)
  )
```

#### Plot

```{r plot function}
forest_plot <-
  function(data,
           x,
           y,
           colour,
           point_shape,
           error_low,
           error_high,
           bar_dodge,
           x_axis_low,
           x_axis_high,
           x_axis_break,
           predictor_label_1 = "Acquisition CS-",
           predictor_label_2 = "Extinction CS+",
           predictor_label_3 = is.null,
           predictor_label_4 = is.null) {
    
    # Initialise plot
    ggplot(data, 
           aes(x = {{x}},
               y = {{y}},
               colour = {{colour}})) +
      
      # Scatterplot layer
      geom_point(aes(shape = {{point_shape}}),
                 size = 2,
                 position = position_dodge(width = bar_dodge)) +
      
      # Error bars
      geom_errorbar(aes(xmin = {{error_low}}, 
                        xmax = {{error_high}}),
                    position = position_dodge(width = bar_dodge),
                    width = 0) +
      
      # X-axis
      scale_x_continuous(
        limits = c(x_axis_low, x_axis_high), 
        breaks = round(seq(x_axis_low, x_axis_high, by = x_axis_break), 1)) +
      
      # Line at zero
      geom_vline(xintercept = 0, linetype = "dashed") +
      
      # Colour/shape settings
      scale_color_manual(
        values = c("#811D1C", "#153860", "#FF4E00", "#55C1FF"),
        labels = c(
          predictor_label_1, 
          predictor_label_2, 
          predictor_label_3, 
          predictor_label_4
          ),
        # Prevents inclusion in legend
        guide = "none"
      ) +
      
      scale_shape_manual(values = c(1, 16),
                         labels = c("p >= 0.05", "p < 0.05"),
                         # Prevents unused levels being dropped from the legend
                         drop = FALSE) +
      
      # Theme
      theme_minimal() +
      theme(
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        strip.text.x = element_blank(),
        plot.caption = element_text(hjust = 0),
        plot.title = element_text(size = 11),
        plot.subtitle = element_text(size = 10),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8)
      ) +
      
      # Labels
      labs(
        x = "Standardised beta coefficients",
        y = element_blank(),
        shape = "Significance"
      )
  }
```

```{r primary plot, warning=FALSE}
primary_models_tidy %>%
  filter(iv == TRUE) %>%
  
  # Plot
  forest_plot(
    data = .,
    x = estimate,
    y = term,
    colour = term,
    point_shape = sig_05_adj,
    error_low = conf.low,
    error_high = conf.high,
    bar_dodge = 0.2,
    x_axis_low = -2,
    x_axis_high = 2,
    x_axis_break = 1
  ) +
  
  # Labels
  scale_y_discrete(
    labels = c(
      "exp_acquisition_cs_minus_mean_z" = "Acquisition CS-",
      "exp_extinction_cs_plus_mean_z" = "Extinction CS+"
    )
  ) +
  labs(caption = paste0(
    "Intercepts",
    "\nAcquisition CS- (model 1) = ",
    round(pri_acq_minus_model$coefficients[1], digits = 2),
    "\nExtinction CS+ (model 2) = ",
    round(pri_ext_plus_model$coefficients[1], digits = 2)
  ))

suppressMessages(ggsave(
  here("reports", "figures", "primary-regression-forest-plot.png"),
  bg = "white"
))
```

## Secondary

### Age/Sex adjustment {.tabset}

The first set of secondary analyses repeats the same models as the primary analyses, except age and sex are controlled for (included as covariates).

#### Acquisition CS-

```{r secondary age/sex acq}
# Generate model
sec_acq_minus_model1 <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_acquisition_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z +
      demographics_age_at_screening_years_z +
      demographics_biological_sex,
    data = .
  )

# Model output
summary(sec_acq_minus_model1)

# Save single row summary of model
sec_acq_minus_model_glance1 <- 
  glance(sec_acq_minus_model1)

# Save summary dataframe of test results
sec_acq_minus_model_tidy1 <- 
  tidy(sec_acq_minus_model1, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - age and sex adjustment", 
         model = "acquisition_cs_minus", 
         .before = everything())
```

#### Extinction CS+

```{r secondary age/sex ext}
# Generate model
sec_ext_plus_model1 <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_extinction_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z +
      demographics_age_at_screening_years_z +
      demographics_biological_sex,
    data = .
  )

# Model output
summary(sec_ext_plus_model1)

# Save single row summary of model
sec_ext_plus_model_glance1 <- 
  glance(sec_ext_plus_model1)

# Save summary dataframe of test results
sec_ext_plus_model_tidy1 <- 
  tidy(sec_ext_plus_model1, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - age and sex adjustment", 
         model = "extinction_cs_plus", 
         .before = everything())
```

### GAD-7 at follow-up (DV) {.tabset}

The second set of secondary analyses repeats the same models as the primary analyses, except GAD-7 scores from follow-up are used as the outcome variable instead of GAD-7 scores from participants' final treatment session.

#### Acquisition CS-

```{r secondary followup gad acq}
# Generate model
sec_acq_minus_model2 <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_followup_total ~ 
      exp_acquisition_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(sec_acq_minus_model2)

# Save single row summary of model
sec_acq_minus_model_glance2 <- 
  glance(sec_acq_minus_model2)

# Save summary dataframe of test results
sec_acq_minus_model_tidy2 <- 
  tidy(sec_acq_minus_model2, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - gad7 followup dv", 
         model = "acquisition_cs_minus", 
         .before = everything())
```

#### Extinction CS+

```{r secondary followup gad ext}
# Generate model
sec_ext_plus_model2 <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_followup_total ~ 
      exp_extinction_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(sec_ext_plus_model2)

# Save single row summary of model
sec_ext_plus_model_glance2 <- 
  glance(sec_ext_plus_model2)

# Save summary dataframe of test results
sec_ext_plus_model_tidy2 <- 
  tidy(sec_ext_plus_model2, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - gad7 followup dv", 
         model = "extinction_cs_plus", 
         .before = everything())
```

### FSS scores at follow-up {.tabset}

The third set of secondary analyses repeats the same models as the primary analyses, except FSS scores from follow-up are used as the outcome variable instead of GAD-7 scores from participants' final treatment session and FSS scores at baseline are controlled for instead of first treatment session GAD-7 scores.

#### Acquisition CS-

```{r secondary fss acq}
# Generate model
sec_acq_minus_model3 <- 
  port_data_exclusions_applied_std %>%
  lm(
    fss_followup_total ~ 
      exp_acquisition_cs_minus_mean_z + 
      fss_baseline_total_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(sec_acq_minus_model3)

# Save single row summary of model
sec_acq_minus_model_glance3 <- 
  glance(sec_acq_minus_model3)

# Save summary dataframe of test results
sec_acq_minus_model_tidy3 <- 
  tidy(sec_acq_minus_model3, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - fss followup dv", 
         model = "acquisition_cs_minus", 
         .before = everything())
```

#### Extinction CS+

```{r secondary fss ext}
# Generate model
sec_ext_plus_model3 <- 
  port_data_exclusions_applied_std %>%
  lm(
    fss_followup_total ~ 
      exp_extinction_cs_plus_mean_z + 
      fss_baseline_total_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(sec_ext_plus_model3)

# Save single row summary of model
sec_ext_plus_model_glance3 <- 
  glance(sec_ext_plus_model3)

# Save summary dataframe of test results
sec_ext_plus_model_tidy3 <- 
  tidy(sec_ext_plus_model3, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - fss followup dv", 
         model = "extinction_cs_plus", 
         .before = everything())
```

### Combine

```{r secondary combine dataframes}
# Combine tidied dataframes for potential plotting and tables
secondary_models_tidy <-
  rbind(
    sec_acq_minus_model_tidy1, 
    sec_ext_plus_model_tidy1,
    sec_acq_minus_model_tidy2, 
    sec_ext_plus_model_tidy2,
    sec_acq_minus_model_tidy3, 
    sec_ext_plus_model_tidy3
    )

# Create a dataframe including only fear conditioning predictors
secondary_models_tidy_fc <- 
  secondary_models_tidy %>% 
  filter(str_detect(term, "exp_")) %>% 
  
  # Apply Holm Bonferonni correction
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 6))

# Do the same for non-fc predictors
secondary_models_tidy_non_fc <- 
  secondary_models_tidy %>% 
  filter(!str_detect(term, "exp_")) %>% 
  # Set corrected p values to missing
  mutate(pval.adj = NA)

# Bind dataframes back together
secondary_models_tidy <-
  rbind(secondary_models_tidy_fc, secondary_models_tidy_non_fc) %>%
  # Add significance and IV flags
  mutate(
    sig_05 = factor(if_else(p.value < 0.05, TRUE, FALSE), levels = c("FALSE", "TRUE")),
    sig_05_adj = factor(if_else(pval.adj < 0.05, TRUE, FALSE), levels = c("FALSE", "TRUE")),
    iv = case_when(
      term == "(Intercept)" ~ FALSE,
      term == "gad7_treatment_total_1_z" ~ FALSE,
      term == "fss_baseline_total_z" ~ FALSE,
      term == "ieso_treatment_completed_total_z" ~ FALSE,
      term == "demographics_age_at_screening_years_z" ~ FALSE,
      term == "demographics_biological_sexmale" ~ FALSE,
      TRUE ~ TRUE
    ),
    term = fct_rev(term)
  )
```

### Plot

Plots for secondary analyses not saved as they will not appear in the paper.

```{r secondary plot, warning=FALSE}
secondary_models_tidy %>%
  filter(iv == TRUE) %>%
  group_by(analysis) %>% 
  group_map(
    .f = ~forest_plot(
    data = .,
    x = estimate,
    y = term,
    colour = term,
    point_shape = sig_05_adj,
    error_low = conf.low,
    error_high = conf.high,
    bar_dodge = 0.2,
    x_axis_low = -2,
    x_axis_high = 2,
    x_axis_break = 1
  ) +
  
  # Labels
  scale_y_discrete(
    labels = c(
      "exp_acquisition_cs_minus_mean_z" = "Acquisition CS-",
      "exp_extinction_cs_plus_mean_z" = "Extinction CS+"
    )
  ) +
  labs(
    title = .y
    )
  )
```

## Exploratory {.tabset}

### Discrimination scores (IV) {.tabset}

The first set of exploratory analyses use US-expectancy discrimination 
(CS+ minus CS-) scores to predict last session GAD-7 scores while controlling 
for first session GAD-7 score and number of treatment sessions completed.

#### Acquisition
```{r exploratory acq differential}
# Generate model
expl_acq_diff_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_acquisition_differential_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_acq_diff_model)

# Save single row summary of model
expl_acq_diff_model_glance1 <- 
  glance(expl_acq_diff_model)

# Save summary dataframe of test results
expl_acq_diff_model_tidy1 <- 
  tidy(expl_acq_diff_model, conf.int = T) %>%
  # Add column describing model for later merge
  mutate(analysis = "exploratory - discrimination scores", 
         model = "acquisition differential", 
         .before = everything())
```

#### Extinction
```{r exploratory ext differential}
# Generate model
expl_ext_diff_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_extinction_differential_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_ext_diff_model)

# Save single row summary of model
expl_ext_diff_model_glance1 <- 
  glance(expl_ext_diff_model)

# Save summary dataframe of test results
expl_ext_diff_model_tidy1 <- 
  tidy(expl_ext_diff_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - discrimination scores", 
         model = "extinction_differential", 
         .before = everything())
```

### Affective ratings (IV) {.tabset}

The second set of exploratory analyses use affective ratings to predict last 
session GAD-7 scores while controlling for first session GAD-7 score and number 
of treatment sessions completed.

#### Post-acquisition CS+
```{r exploratory post-acq cs+}
# Generate model
expl_acq_cs_plus_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      aff_break_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_acq_cs_plus_model)

# Save single row summary of model
expl_acq_plus_model_glance2 <- 
  glance(expl_acq_cs_plus_model)

# Save summary dataframe of test results
expl_acq_cs_plus_model_tidy2 <- 
  tidy(expl_acq_cs_plus_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - affective ratings", 
         model = "post-acquisition cs+", 
         .before = everything())
```

#### Post-acquisition CS-
```{r exploratory post-acq cs-}
# Generate model
expl_acq_cs_minus_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      aff_break_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_acq_cs_minus_model)

# Save single row summary of model
expl_acq_minus_model_glance2 <- 
  glance(expl_acq_cs_minus_model)

# Save summary dataframe of test results
expl_acq_cs_minus_model_tidy2 <- 
  tidy(expl_acq_cs_minus_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - affective ratings", 
         model = "post-acquisition cs-", 
         .before = everything())
```

#### Post-extinction CS+
```{r exploratory post-ext cs+}
# Generate model
expl_ext_cs_plus_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      aff_post_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_ext_cs_plus_model)

# Save single row summary of model
expl_ext_plus_model_glance2 <- 
  glance(expl_ext_cs_plus_model)

# Save summary dataframe of test results
expl_ext_cs_plus_model_tidy2 <- 
  tidy(expl_ext_cs_plus_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - affective ratings", 
         model = "post-extinction cs+", 
         .before = everything())
```

#### Post-extinction CS-
```{r exploratory post-ext cs-}
# Generate model
expl_ext_cs_minus_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      aff_post_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_ext_cs_minus_model)

# Save single row summary of model
expl_ext_minus_model_glance2 <- 
  glance(expl_ext_cs_minus_model)

# Save summary dataframe of test results
expl_ext_cs_minus_model_tidy2 <- 
  tidy(expl_ext_cs_minus_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - affective ratings", 
         model = "post-extinction cs-", 
         .before = everything())
```
### Non-fear conditioning (IVs) {.tabset}

The third set of exploratory analyses uses anxiety-related variables to predict last session GAD-7 scores while controlling for first session GAD-7 score and number of treatment sessions completed.

#### ASI
```{r exploratory asi}
# Generate model
expl_asi_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      asi_baseline_total_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_asi_model)

# Save single row summary of model
expl_asi_model_glance3 <- 
  glance(expl_asi_model)

# Save summary dataframe of test results
expl_asi_model_tidy3 <- 
  tidy(expl_asi_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - non-fc predictors", 
         model = "asi", 
         .before = everything())
```

#### CBAS
```{r exploratory cbas}
# Generate model
expl_cbas_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      cbas_baseline_total_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_cbas_model)

# Save single row summary of model
expl_cbas_model_glance3 <- 
  glance(expl_cbas_model)

# Save summary dataframe of test results
expl_cbas_model_tidy3 <- 
  tidy(expl_cbas_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - non-fc predictors", 
         model = "cbas", 
         .before = everything())
```

#### eACS
```{r exploratory eacs}
# Generate model
expl_eacs_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      eacs_midapp_total_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_eacs_model)

# Save single row summary of model
expl_eacs_model_glance3 <- 
  glance(expl_eacs_model)

# Save summary dataframe of test results
expl_eacs_model_tidy3 <- 
  tidy(expl_eacs_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - non-fc predictors", 
         model = "eacs", 
         .before = everything())
```

### Depression (covariate) {.tabset}

The fourth set of exploratory analyses repeats the primary analyses while 
additionally adjusting for depression symptoms.

#### Acquisition CS-

```{r exploratory acq}
# Generate model
expl_acq_minus_dep_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_acquisition_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z +
      phq9_treatment_total_1_z,
    data = .
  )

# Model output
summary(expl_acq_minus_dep_model)

# Save single row summary of model
expl_acq_minus_model_glance4 <- 
  glance(expl_acq_minus_dep_model)

# Save summary dataframe of test results
expl_acq_minus_dep_model_tidy4 <- 
  tidy(expl_acq_minus_dep_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - depression adjustment", 
         model = "acquisition cs-", 
         .before = everything())
```

#### Extinction CS+

```{r exploratory ext}
# Generate model
expl_ext_plus_dep_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_extinction_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z +
      phq9_treatment_total_1_z,
    data = .
  )

# Model output
summary(expl_ext_plus_dep_model)

# Save single row summary of model
expl_ext_plus_model_glance4 <- 
  glance(expl_ext_plus_dep_model)

# Save summary dataframe of test results
expl_ext_plus_dep_model_tidy4 <- 
  tidy(expl_ext_plus_dep_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - depression adjustment", 
         model = "extinction cs+", 
         .before = everything())
```

### Low GAD-7 excluded {.tabset}

The fifth set of exploratory analyses repeats those from the primary analyses 
with participants excluded if their GAD-7 score is lower than eight on their 
first treatment session.

#### Acquisition CS-

```{r exploratory low gad exclusion acq}
# Generate model
expl_acq_low_anx_exc_model <- 
  port_data_exclusions_applied_std %>%
  filter(gad7_treatment_total_1 >= 8) %>% 
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_acquisition_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_acq_low_anx_exc_model)

# Save single row summary of model
expl_acq_minus_model_glance5 <- 
  glance(expl_acq_low_anx_exc_model)

# Save summary dataframe of test results
expl_acq_low_anx_exc_model_tidy5 <- 
  tidy(expl_acq_low_anx_exc_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - low gad excluded", 
         model = "acquisition cs-", 
         .before = everything())
```

#### Extinction CS+

```{r exploratory low gad exclusion ext}
# Generate model
expl_ext_low_anx_exc_model <- 
  port_data_exclusions_applied_std %>%
  filter(gad7_treatment_total_1 >= 8) %>% 
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_extinction_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_ext_low_anx_exc_model)

# Save single row summary of model
expl_ext_plus_model_glance5 <- 
  glance(expl_ext_low_anx_exc_model)

# Save summary dataframe of test results
expl_ext_low_anx_exc_model_tidy5 <- 
  tidy(expl_ext_low_anx_exc_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - low gad excluded", 
         model = "extinction cs+", 
         .before = everything())
```


### Non-completers excluded {.tabset}

The sixth set of exploratory analyses repeats those from the primary analyses with participants excluded if they were not classified as treatment completers.

#### Acquisition CS-

```{r exploratory treatment completers acq}
# Generate model
expl_acq_treat_complete_model <- 
  port_data_exclusions_applied_std %>%
  filter(ieso_discharge_reason_primary == "completed_treatment") %>% 
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_acquisition_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_acq_treat_complete_model)

# Save single row summary of model
expl_acq_minus_model_glance6 <- 
  glance(expl_acq_treat_complete_model)

# Save summary dataframe of test results
expl_acq_treat_complete_model_tidy6 <- 
  tidy(expl_acq_treat_complete_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - treatment completers", 
         model = "acquisition cs-", 
         .before = everything())
```

#### Extinction CS+

```{r exploratory treatment completers ext}
# Generate model
expl_ext_treat_complete_model <- 
  port_data_exclusions_applied_std %>%
  filter(ieso_discharge_reason_primary == "completed_treatment") %>% 
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_extinction_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(expl_ext_treat_complete_model)

# Save single row summary of model
expl_ext_plus_model_glance6 <- 
  glance(expl_ext_treat_complete_model)

# Save summary dataframe of test results
expl_ext_treat_complete_model_tidy6 <- 
  tidy(expl_ext_treat_complete_model, conf.int = T) %>% 
  # Add column describing model for later merge
  mutate(analysis = "exploratory - treatment completers", 
         model = "extinction cs+", 
         .before = everything())
```

### Combine

```{r exploratory combine dataframes}
# Combine tidied dataframes for potential plotting and tables
exploratory_models_tidy <-
  rbind(
    expl_acq_diff_model_tidy1,
    expl_ext_diff_model_tidy1,
    expl_acq_cs_plus_model_tidy2,
    expl_acq_cs_minus_model_tidy2,
    expl_ext_cs_plus_model_tidy2,
    expl_ext_cs_minus_model_tidy2,
    expl_asi_model_tidy3,
    expl_cbas_model_tidy3,
    expl_eacs_model_tidy3,
    expl_acq_minus_dep_model_tidy4,
    expl_ext_plus_dep_model_tidy4,
    expl_acq_low_anx_exc_model_tidy5,
    expl_ext_low_anx_exc_model_tidy5,
    expl_acq_treat_complete_model_tidy6,
    expl_ext_treat_complete_model_tidy6
    )

# Create a dataframe including only fear conditioning predictors
exploratory_models_tidy_fc <- 
  exploratory_models_tidy %>% 
  filter(term %in% c(
    "exp_acquisition_differential_mean_z",
    "exp_extinction_differential_mean_z",
    "aff_break_cs_plus_mean_z",
    "aff_break_cs_minus_mean_z",
    "aff_post_cs_plus_mean_z",
    "aff_post_cs_minus_mean_z",
    "asi_baseline_total_z",
    "cbas_baseline_total_z",
    "eacs_midapp_total_z",
    "exp_acquisition_cs_minus_mean_z",
    "exp_extinction_cs_plus_mean_z"
  )) %>% 
  
  # Apply Holm Bonferonni correction
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 15))

# Do the same for non-fc predictors
exploratory_models_tidy_non_fc <- 
  exploratory_models_tidy %>% 
  filter(term %!in% c(
    "exp_acquisition_differential_mean_z",
    "exp_extinction_differential_mean_z",
    "aff_break_cs_plus_mean_z",
    "aff_break_cs_minus_mean_z",
    "aff_post_cs_plus_mean_z",
    "aff_post_cs_minus_mean_z",
    "asi_baseline_total_z",
    "cbas_baseline_total_z",
    "eacs_midapp_total_z",
    "exp_acquisition_cs_minus_mean_z",
    "exp_extinction_cs_plus_mean_z"
  )) %>% 
  # Set corrected p values to missing
  mutate(pval.adj = NA)

# Bind dataframes back together
exploratory_models_tidy <-
  rbind(exploratory_models_tidy_fc, exploratory_models_tidy_non_fc) %>%
  # Add significance and IV flags
  mutate(
    sig_05 = factor(if_else(p.value < 0.05, TRUE, FALSE), levels = c("FALSE", "TRUE")),
    sig_05_adj = factor(if_else(pval.adj < 0.05, TRUE, FALSE), levels = c("FALSE", "TRUE")),
    iv = case_when(
      term == "(Intercept)" ~ FALSE,
      term == "gad7_treatment_total_1_z" ~ FALSE,
      term == "ieso_treatment_completed_total_z" ~ FALSE,
      term == "phq9_treatment_total_1_z" ~ FALSE,
      TRUE ~ TRUE
    ),
    term = fct_rev(term)
  )
```

### Plot

Plots for secondary analyses not saved as they will not appear in the paper.

```{r exploratory plot, warning=FALSE}
exploratory_models_tidy %>%
  filter(
    iv == TRUE
  ) %>%
  group_by(analysis) %>% 
  group_map(
    .f = ~forest_plot(
    data = .,
    x = estimate,
    y = term,
    colour = term,
    point_shape = sig_05_adj,
    error_low = conf.low,
    error_high = conf.high,
    bar_dodge = 0.2,
    x_axis_low = -2,
    x_axis_high = 2,
    x_axis_break = 1
  ) +
  
  # Labels
  scale_y_discrete(
    labels = c(
      "exp_acquisition_differential_mean_z" = "Acquisition differential",
      "exp_extinction_differential_mean_z" = "Extinction differential",
      "aff_break_cs_plus_mean_z" = "Post-acquisition affect CS+",
      "aff_break_cs_minus_mean_z" = "Post-acquisition affect CS-",
      "aff_post_cs_plus_mean_z" = "Post-extinction affect CS+",
      "aff_post_cs_minus_mean_z" = "Post-extinction affect CS-",
      "asi_baseline_total_z" = "ASI",
      "cbas_baseline_total_z" = "CBAS",
      "eacs_midapp_total_z" = "EACS",
      "exp_acquisition_cs_minus_mean_z" = "Acquisition CS-",
      "exp_extinction_cs_plus_mean_z" = "Extinction CS+"
    )
  ) +
  labs(
    title = .y
    )
  )
```

## Save tables

### Coefficients

#### All models

```{r save regression tables}
# Coefficients
regression_model_coefficients <-
  rbind(primary_models_tidy,
        secondary_models_tidy,
        exploratory_models_tidy) %>%
  separate(analysis, into = c("analysis type", "analysis description"), sep = " - ") %>% 
  mutate(`analysis description` = replace_na(`analysis description`, "Expectancy ratings"),
         p = if_else(p.value < 0.001, paste0("<0.001"), paste0(round(p.value, 3))),
         p.adj = if_else(pval.adj <0.001, paste0("<0.001"), paste0(round(pval.adj, 3))),
         across(.cols = where(is.numeric),
                .fns = ~ round(.x, 2)),
         term = fct_reorder(term, iv),
         term = fct_relevel(term, "(Intercept)"),
         `analysis type` = fct_relevel(`analysis type`, c("primary", "secondary", "exploratory"))) %>% 
  group_by(`analysis type`, `analysis description`, model) %>% 
  arrange(term, .by_group = TRUE) %>% 
  ungroup()


regression_model_coefficients_tidied <-
  regression_model_coefficients %>%
  transmute(
    `Analysis type` = str_to_title(`analysis type`),
    Model = str_to_sentence(`analysis description`) %>%
      str_replace_all(., c(
        dv = "(DV)",
        Fss = "FSS",
        followup = "follow up",
        Gad7 = "GAD-7"
      )),
    Term = case_match(
      term,
      "(Intercept)" ~ "Intercept",
      "ieso_treatment_completed_total_z" ~ "Treatment sessions completed",
      "gad7_treatment_total_1_z" ~ "Session 1 GAD-7 total",
      "exp_acquisition_cs_minus_mean_z" ~ "Acquisition CS- mean",
      "exp_extinction_cs_plus_mean_z" ~ "Extinction CS+ mean",
      "demographics_biological_sexmale" ~ "Sex assigned at birth",
      "demographics_age_at_screening_years_z" ~ "Age (years)",
      "fss_baseline_total_z" ~ "FSS baseline total",
      "aff_break_cs_plus_mean_z" ~ "Post-acquisition CS+ mean",
      "aff_break_cs_minus_mean_z" ~ "Post-acquisition CS- mean",
      "aff_post_cs_plus_mean_z" ~ "Post-extinction CS+ mean",
      "aff_post_cs_minus_mean_z" ~ "Post-extinction CS- mean",
      "phq9_treatment_total_1_z" ~ "Session 1 PHQ-9 total",
      "exp_acquisition_differential_mean_z" ~ "Acquisition mean discrimination",
      "exp_extinction_differential_mean_z" ~ "Extinction mean discrimination",
      "asi_baseline_total_z" ~ "Baseline ASI total",
      "cbas_baseline_total_z" ~ "Baseline CBAS total",
      "eacs_midapp_total_z" ~ "Baseline eACS total"
    ),
    `Std. beta coefficient (Std. error)` = paste0(estimate, " (", std.error, ")"),
    `95% CIs` = paste0(conf.low, ", ", conf.high),
    `t` = statistic,
    `p-value (adjusted)` = if_else(
      is.na(p.adj),
      paste0(p),
      paste0(p, " (", p.adj, ")")
    )
  )

write_csv(
  regression_model_coefficients_tidied,
  here("reports", "tables", "regression_model_coefficients.csv")
)
```

#### Separated by analysis type
Also converted to gt tables

##### Primary

```{r}
# Primary models
regression_model_coefficients_tidied_primary <-
  regression_model_coefficients_tidied %>%
  filter(`Analysis type` == "Primary") %>%
  select(-`Analysis type`) %>%
  mutate(Model = if_else(
    row_number() <= 4,
    paste0(Model, " (model 1)"),
    paste0(Model, " (model 2)")
  )) %>%
  group_by(Model) %>% 
  gt() %>% 
  tab_style(
    style = cell_fill(color = "lightgrey"),
    locations = cells_body(rows = c(4, 8))
  )

regression_model_coefficients_tidied_primary

suppressMessages(gtsave(
  regression_model_coefficients_tidied_primary,
  filename = here("reports", "tables", "primary_coefficients_table.png"),
  expand = 10
))

```

##### Secondary
```{r}
# Secondary models
regression_model_coefficients_tidied_secondary <-
  regression_model_coefficients_tidied %>%
  filter(`Analysis type` == "Secondary") %>%
  select(-`Analysis type`) %>%
  mutate(Model_x = case_when(
    row_number() <= 6 ~ "model 1",
    row_number() <= 12 ~ "model 2",
    row_number() <= 16 ~ "model 1",
    row_number() <= 20 ~ "model 2",
    row_number() <= 24 ~ "model 1",
    row_number() <= 28 ~ "model 2"
  )) %>%
  group_by(Model, Model_x) %>% 
  gt() %>% 
  tab_style(
    style = cell_fill(color = "lightgrey"),
    locations = cells_body(rows = c(6, 12, 16, 20, 24, 28))
  )

regression_model_coefficients_tidied_secondary

suppressMessages(gtsave(
  regression_model_coefficients_tidied_secondary,
  filename = here("reports", "tables", "secondary_coefficients_table.png"),
  expand = 10
))

```

### Model fits

#### All models
```{r}
regression_model_fits <- rbind(
  pri_acq_minus_model_glance,
  pri_ext_plus_model_glance,
  sec_acq_minus_model_glance1,
  sec_ext_plus_model_glance1,
  sec_acq_minus_model_glance2,
  sec_ext_plus_model_glance2,
  sec_acq_minus_model_glance3,
  sec_ext_plus_model_glance3,
  expl_acq_diff_model_glance1,
  expl_ext_diff_model_glance1,
  expl_acq_plus_model_glance2,
  expl_acq_minus_model_glance2,
  expl_ext_plus_model_glance2,
  expl_ext_minus_model_glance2,
  expl_asi_model_glance3,
  expl_cbas_model_glance3,
  expl_eacs_model_glance3,
  expl_acq_minus_model_glance4,
  expl_ext_plus_model_glance4,
  expl_acq_minus_model_glance5,
  expl_ext_plus_model_glance5,
  expl_acq_minus_model_glance6,
  expl_ext_plus_model_glance6
) %>%
  mutate(
    analysis = c(
      "primary - expectancy ratings",
      "primary - expectancy ratings",
      "secondary - age and sex adjustment",
      "secondary - age and sex adjustment",
      "secondary - gad7 followup dv",
      "secondary - gad7 followup dv",
      "secondary - fss followup dv",
      "secondary - fss followup dv",
      "exploratory - discrimination scores",
      "exploratory - discrimination scores",
      "exploratory - affective ratings",
      "exploratory - affective ratings",
      "exploratory - affective ratings",
      "exploratory - affective ratings",
      "exploratory - non-fc predictors",
      "exploratory - non-fc predictors",
      "exploratory - non-fc predictors",
      "exploratory - depression adjustment",
      "exploratory - depression adjustment",
      "exploratory - low gad excluded",
      "exploratory - low gad excluded",
      "exploratory - treatment completers",
      "exploratory - treatment completers"
    ),
    model = c(
      "acquisition_cs_minus",
      "extinction_cs_plus",
      "acquisition_cs_minus",
      "extinction_cs_plus",
      "acquisition_cs_minus",
      "extinction_cs_plus",
      "acquisition_cs_minus",
      "extinction_cs_plus",
      "acquisition",
      "extinction",
      "post-acquisition_cs_plus",
      "post-acquisition_cs_minus",
      "post-extinction_cs_plus",
      "post-extinction_cs_minus",
      "asi",
      "cbas",
      "eacs",
      "acquisition_cs_minus",
      "extinction_cs_plus",
      "acquisition_cs_minus",
      "extinction_cs_plus",
      "acquisition_cs_minus",
      "extinction_cs_plus"
    ),
    .before = everything()
  ) %>%
  mutate(p = if_else(p.value <0.001, paste0("<0.001"), paste0(round(p.value, 3))),
         across(.cols = where(is.numeric),
                .fns = ~ round(.x, 2))) %>%
  separate(analysis,
           into = c("analysis type", "analysis description"),
           sep = " - ") %>%
  mutate(
    `analysis type` = fct_relevel(`analysis type`, c("primary", "secondary", "exploratory")),
    model = case_match(
      model,
      "acquisition_cs_minus" ~ "acquisition CS-",
      "extinction_cs_plus" ~ "extinction CS+",
      "post-acquisition_cs_plus" ~ "post-acquisition CS+",
      "post-acquisition_cs_minus" ~ "post-acquisition CS-",
      "post-extinction_cs_plus" ~ "post-extinction CS+",
      "post-extinction_cs_minus" ~ "post-extinction CS-",
      "asi" ~ "ASI",
      "cbas" ~ "CBAS",
      "eacs" ~ "eACS",
      .default = model
    )
  )


regression_model_fits_tidied <-
  regression_model_fits %>%
  transmute(
    `Analysis type` = str_to_title(`analysis type`),
    Model = paste0(str_to_sentence(`analysis description`) %>%
      str_replace_all(., c(
        dv = "(DV)",
        Fss = "FSS",
        followup = "follow up",
        Gad7 = "GAD-7",
        gad = "GAD-7",
        `Non-fc` = "Non-FC"
      )), " (", model, ")"),
    `R-squared (adjusted)` = paste0(r.squared, " (", adj.r.squared, ")"),
    df = paste0(df, ", ", df.residual),
    `F` = statistic,
    `p-value` = p,
    n = nobs)

write_csv(regression_model_fits_tidied,
          here("reports", "tables", "regression_model_fits.csv"))
```



## Not pre-registered {.tabset}

### Percentage of extinction learning
Mean CR [(CS+) - (CS-)] of early extinction learning / mean CR [(CS+) - (CS-)] 
of last two trials of conditioning.
```{r}
test <- 
  port_data_exclusions_applied_std %>%
  mutate(
    exp_extinction_cs_plus_1_to_6_mean =
      rowMeans(
        select(
          .,
          exp_extinction_cs_plus_1,
          exp_extinction_cs_plus_2,
          exp_extinction_cs_plus_3,
          exp_extinction_cs_plus_4,
          exp_extinction_cs_plus_5,
          exp_extinction_cs_plus_6
        )
      ),
    exp_extinction_cs_minus_1_to_6_mean =
      rowMeans(
        select(
          .,
          exp_extinction_cs_minus_1,
          exp_extinction_cs_minus_2,
          exp_extinction_cs_minus_3,
          exp_extinction_cs_minus_4,
          exp_extinction_cs_minus_5,
          exp_extinction_cs_minus_6
        )
      ),
    exp_acquisition_cs_plus_11_to_12_mean =
      rowMeans(
        select(.,
               exp_acquisition_cs_plus_11,
               exp_acquisition_cs_plus_12)
      ),
    exp_acquisition_cs_minus_11_to_12_mean =
      rowMeans(
        select(.,
               exp_acquisition_cs_minus_11,
               exp_acquisition_cs_minus_12)
      ),
    exp_extinction_1_to_6_difference_mean = 
      exp_extinction_cs_plus_1_to_6_mean - exp_extinction_cs_minus_1_to_6_mean,
    exp_acquisition_11_to_12_difference_mean = 
      exp_acquisition_cs_plus_11_to_12_mean - exp_acquisition_cs_minus_11_to_12_mean,
    proportion_extinction_1_to_6_acquisition_11_to_12_difference_mean = 
      exp_extinction_1_to_6_difference_mean / exp_acquisition_11_to_12_difference_mean
  )

summary(test$proportion_extinction_1_to_6_acquisition_11_to_12_difference_mean)
```

### Complete cases only

### Anxiety diagnoses only

### Exposure treatment only

# Visualisations {.tabset}

## Elephant

```{r elephant wrangling, include=FALSE}
# Create a list of expectancy rating trial variables
elephant_long <- port_data_exclusions_applied %>% 
  select(matches("^exp_.*\\d$")) %>%
  mutate(n = nrow(.)) %>% 
  pivot_longer(cols = -n, names_to = "variable", values_to = "rating") %>% 
  mutate(variable = str_remove(variable, "exp_")) %>%
  separate(variable, into = c("phase", "cs", "stimulus", "trial"), sep = "_") %>% 
  select(-cs) %>% 
  mutate(trial = as.numeric(trial)) %>% 
  group_by(phase, stimulus, trial) %>% 
  summarise(mean = mean(rating, na.rm = T), std_dev = sd(rating, na.rm = T), n = mean(n), .groups = "keep") %>% 
  mutate(sem = std_dev / sqrt(n),
         ci_low = mean - 2*(sem),
         ci_high = mean + 2*(sem)) %>% 
  ungroup() %>% 
  mutate(Phase = str_to_sentence(phase),
         Phase = factor(Phase, levels = c("Acquisition", "Extinction")),
         Stimulus = factor(stimulus, levels = c("plus", "minus")),
         Stimulus = fct_recode(Stimulus, "CS+" = "plus", "CS-" = "minus")) %>% 
  select(Phase, Stimulus, Trial = trial, everything()) %>% 
  select(-c(phase, stimulus)) %>% 
  arrange(Phase, Stimulus, Trial)

# Function for breaks
breaks_fun <- function(x) {
  if (max(x) > 12) {
    seq(0, 18, 1)
  } else {
    seq(0, 12, 1)
  }
}
```

```{r elephant plot}
elephant_plot_exclusions_applied <- elephant_long %>% 
  ggplot(aes(x = Trial, y = mean, color = Stimulus)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = ci_low, ymax = ci_high, fill = Stimulus),
              linetype = 0,
              alpha = 0.3,
              linewidth = 0.8
  ) +
  scale_fill_manual(values = c("#811D1C", "#153860")) +
  scale_colour_manual(values = c("#811D1C", "#153860")) +
  facet_grid(~ Phase, 
               scales = "free_x",
               space = "free_x"
    ) +
    # adjust the labels
    labs(y="Mean expectancy rating", 
         x = "Trials"
    ) +
    theme(strip.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.position = 'bottom',
          text = element_text(size = 10),
          strip.text.x = element_text(size = 10)
    ) +
    scale_x_continuous(breaks = breaks_fun) +
    scale_y_continuous(breaks = seq(0, 10, by = 1), limits = c(1, 9))

elephant_plot_exclusions_applied

# Save
ggsave(
  file = paste0(here("reports", "figures"), "/elephant-plot_exclusions-applied.png"), 
  plot = elephant_plot_exclusions_applied, 
  width = 16, 
  height = 8, 
  units = "cm",
  bg = "white"
  )
```
