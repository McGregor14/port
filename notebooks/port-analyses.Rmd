---
title: "PORT analyses"
author: "Thomas McGregor"
date: "`r Sys.Date()`"
output: html_document
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "../reports"
    )
  })
---

```{r setup, include=FALSE}
# Default to preventing code, but not the results from appearing in the finished 
# file
knitr::opts_chunk$set(echo = FALSE)
```

```{r load packages, include=FALSE}
# Clear workspace
rm(list = ls())

# Load packages
library(broom) # tidying output
library(gt) # creating tables
library(here) # file referencing
library(naniar) # visualise missing data
library(ppcor) # partial correlations
library(summarytools) # data exploration
library(tidyverse) # data manipulation
library(webshot) # required for saving gt tables
```

```{r read data, include=FALSE}
# Read in master dataset
port_data <- read_rds(here("data", "processed", "merged", "07_imputed-processed-data.Rds"))
```

```{r subset}
# Create subsets

# Exclusions applied: all variables, exclusions applied
port_data_exclusions_applied <- port_data %>% 
  filter(port_exclusion == FALSE)

# Subsetted: selected variables, exclusions applied
port_data_subsetted <- port_data %>% 
  filter(port_exclusion == FALSE) %>% 
  select(
    ieso_treatment_completed_total,
    demographics_age_at_screening_years,
    demographics_biological_sex,
    gad7_treatment_total_1,
    gad7_treatment_total_final,
    gad7_treatment_total_final_observed,
    gad7_followup_total,
    exp_acquisition_cs_minus_mean,
    exp_extinction_cs_plus_mean,
    fss_baseline_total,
    fss_followup_total)

# Subsetted, complete cases: selected variables, exclusions applied, no missing 
# data
port_data_subsetted_complete_cases <- na.omit(port_data_subsetted)
```

```{r standardising}
# Standardise (z-score) all continuous variables included in analyses
port_data_exclusions_applied_std <- 
  port_data_exclusions_applied %>%
  mutate(across(
    .cols = c(
      exp_acquisition_cs_minus_mean,
      exp_extinction_cs_plus_mean,
      gad7_treatment_total_1,
      ieso_treatment_completed_total,
      demographics_age_at_screening_years,
      fss_baseline_total
    ),
    .fns = ~ c(scale(.x, scale = TRUE, center = TRUE)),
    .names = "{col}_z"
  ))
```

# Explore

## Visualise missing data

-   Should not be any missing data for variables derived from GLAD (i.e. age at
screening & biological sex)
-   Same goes for fear conditioning variables as missing data should be imputed
(i.e. acquisition CS- and extinction CS+)

```{r visualise missing data, warning=FALSE}
port_data_subsetted %>%  
vis_miss()
```

## Skew & kurtosis

Skewness and Kurtosis values all range between +/- 1.

```{r describe data}
port_data_subsetted %>% 
  # Remove non-numberical variables to avoid warnings
  select(-demographics_biological_sex) %>% 
  descr()
```

## Correlations

### Acquisition CS- x GAD-7 at last session

#### Partial correlation
```{r acq correlation gad7}
# Partial correlation
partial_correlation <- pcor.test(
  port_data_subsetted_complete_cases$gad7_treatment_total_final_observed,
  port_data_subsetted_complete_cases$exp_acquisition_cs_minus_mean,
  port_data_subsetted_complete_cases$gad7_treatment_total_1,
  method="pearson"
)

print(partial_correlation)
```

#### Scatterplot
```{r acq scatterplot gad7}
# Scatterplot
port_data_subsetted %>% 
  ggplot(aes(x = exp_acquisition_cs_minus_mean, y = gad7_treatment_total_final_observed)) +
  geom_point() + 
  geom_smooth(formula = y ~ x, method = "lm")
```

### Extinction CS+ x GAD-7 at last session

#### Partial correlation
```{r ext correlation gad7}
# Partial correlation
pcor.test(
  port_data_subsetted_complete_cases$gad7_treatment_total_final_observed,
  port_data_subsetted_complete_cases$exp_extinction_cs_plus_mean,
  port_data_subsetted_complete_cases$gad7_treatment_total_1,
  method="pearson"
)
```

#### Scatterplot
```{r ext scatterplot gad7}
# Scatterplot
port_data_subsetted %>% 
  ggplot(aes(x = exp_extinction_cs_plus_mean, y = gad7_treatment_total_final_observed)) +
  geom_point() + 
  geom_smooth(formula = y ~ x, method = "lm")
```

# Analyses

## Primary - GAD-7 at last session

Primary analyses use fear conditioning variables to predict last session GAD-7
scores while controlling for first session GAD-7 score and number of treatment 
sessions completed. 

### Acquisition CS-

```{r primary acq}
# Generate model
pri_acq_minus_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_acquisition_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(pri_acq_minus_model)

# Save single row summary of model
pri_acq_minus_model_glance <- 
  glance(pri_acq_minus_model)

# Save summary dataframe of test results
pri_acq_minus_model_tidy <- 
  tidy(pri_acq_minus_model, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 4)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "primary", 
         model = "acquisition_cs_minus", 
         .before = everything())
```

### Extinction CS+

```{r primary ext}
# Generate model
pri_ext_plus_model <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_extinction_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(pri_ext_plus_model)

# Save single row summary of model
pri_ext_plus_model_glance <- 
  glance(pri_ext_plus_model)

# Save summary dataframe of test results
pri_ext_plus_model_tidy <- 
  tidy(pri_ext_plus_model, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 4)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "primary", 
         model = "extinction_cs_plus", 
         .before = everything())
```

### Plot

```{r primary combine dataframes}
# Combine tidied dataframes for potential plotting and tables
primary_models_tidy <-
  rbind(pri_acq_minus_model_tidy, pri_ext_plus_model_tidy) %>%
  mutate(
    sig_05 = if_else(p.value <= 0.05, TRUE, FALSE),
    sig_05_adj = if_else(pval.adj <= 0.05, TRUE, FALSE),
    term = factor(if_else(str_detect(term, "exp_"), "fc", term)),
    iv = case_when(
      term == "gad7_treatment_total_1_z" ~ FALSE,
      term == "ieso_treatment_completed_total_z" ~ FALSE,
      TRUE ~ TRUE
    ),
    term = fct_rev(term)
  )
```

```{r primary plot}
primary_models_tidy %>%
  filter(term != "(Intercept)") %>%
  
  # Plot
  ggplot(aes(
    x = estimate,
    y = term,
    group = fct_rev(model),
    colour = model,
    alpha = iv
  )) +
  geom_point(aes(shape = sig_05_adj),
             size = 2,
             position = position_dodge(width = .3)) +
  
  geom_errorbar(
    aes(xmin = conf.low, xmax = conf.high),
    position = position_dodge(width = .3),
    width = 0
  ) +
  
  scale_x_continuous(limits = c(-5, 5), breaks = round(seq(-5, 5, by = 1),1)) +
  
  geom_vline(xintercept = 0, linetype = "dashed") +
  
  # Colour/shape settings
  scale_color_manual(values = c("#811D1C", "#153860"),
                     labels = c("Acquisition CS-", "Extinction CS+")) +
  scale_shape_manual(values = c(1, 16),
                     labels = c("p > 0.05", "p <= 0.05")) +
  scale_alpha_discrete(range = c(0.5, 1),
                       labels = c("Covariate", "Explanatory")) +
  
  # Labels
  scale_y_discrete(
    labels = c(
      "ieso_treatment_completed_total_z" = "Number of treatment sessions",
      "gad7_treatment_total_1_z" = "First session GAD-7 score",
      "fc" = "Fear conditioning predictor"
    )
  ) +
  labs(
    caption = paste0("Intercepts",
      "\nModel 1 = ",
      round(pri_acq_minus_model$coefficients[1], digits = 2),
      "\nModel 2 = ",
      round(pri_ext_plus_model$coefficients[1], digits = 2)
    ),
    x = "Standardised beta coefficients",
    y = element_blank(),
    shape = "Significance",
    color = "Model",
    alpha = "Variable type"
  ) +
  
  # Theme
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.text.x = element_blank(),
    plot.caption = element_text(hjust = 0),
    plot.title = element_text(size=11),
    plot.subtitle = element_text(size=10),
    legend.title=element_text(size=9),
    legend.text=element_text(size=8)
  )

ggsave(here("reports", "figures", "primary-regression-forest-plot.png"),
  bg = "white")
```

## Secondary

### Age/Sex adjustment
The first set of secondary analyses repeats the same models as the primary 
analyses, except age and sex are controlled for (included as covariates).

#### Acquisition CS-

```{r secondary age/sex acq}
# Generate model
sec_acq_minus_model1 <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_acquisition_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z +
      demographics_age_at_screening_years_z +
      demographics_biological_sex,
    data = .
  )

# Model output
summary(sec_acq_minus_model1)

# Save single row summary of model
sec_acq_minus_model_glance1 <- 
  glance(sec_acq_minus_model1)

# Save summary dataframe of test results
sec_acq_minus_model_tidy1 <- 
  tidy(sec_acq_minus_model1, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 6)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - age and sex adjustment", 
         model = "acquisition_cs_minus", 
         .before = everything())
```

#### Extinction CS+

```{r secondary age/sex ext}
# Generate model
sec_ext_plus_model1 <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_treatment_total_final_observed ~ 
      exp_extinction_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z +
      demographics_age_at_screening_years_z +
      demographics_biological_sex,
    data = .
  )

# Model output
summary(sec_ext_plus_model1)

# Save single row summary of model
sec_ext_plus_model_glance1 <- 
  glance(sec_ext_plus_model1)

# Save summary dataframe of test results
sec_ext_plus_model_tidy1 <- 
  tidy(sec_ext_plus_model1, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 6)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - age and sex adjustment", 
         model = "extinction_cs_plus", 
         .before = everything())
```

#### Plot

```{r secondary age/sex combine dataframes}
# Combine tidied dataframes for potential plotting and tables
secondary_models_tidy1 <-
  rbind(sec_acq_minus_model_tidy1, sec_ext_plus_model_tidy1) %>%
  mutate(
    sig_05 = if_else(p.value <= 0.05, TRUE, FALSE),
    sig_05_adj = if_else(pval.adj <= 0.05, TRUE, FALSE),
    term = factor(if_else(str_detect(term, "exp_"), "fc", term)),
    iv = case_when(
      term == "gad7_treatment_total_1_z" ~ FALSE,
      term == "ieso_treatment_completed_total_z" ~ FALSE,
      term == "demographics_age_at_screening_years_z" ~ FALSE,
      term == "demographics_biological_sexmale" ~ FALSE,
      TRUE ~ TRUE
    ),
    term = factor(
      term,
      level = c(
        "(Intercept)",
        "demographics_biological_sexmale",
        "demographics_age_at_screening_years_z",
        "ieso_treatment_completed_total_z",
        "gad7_treatment_total_1_z",
        "fc"
      )
    )
  )
```

```{r secondary age/sex plot}
secondary_models_tidy1 %>%
  filter(term != "(Intercept)") %>%
  
  # Plot
  ggplot(aes(
    x = estimate,
    y = term,
    group = fct_rev(model),
    colour = model,
    alpha = iv
  )) +
  geom_point(aes(shape = sig_05_adj),
             size = 2,
             position = position_dodge(width = .4)) +
  
  geom_errorbar(
    aes(xmin = conf.low, xmax = conf.high),
    position = position_dodge(width = .4),
    width = 0
  ) +
  
  scale_x_continuous(limits = c(-5, 5), breaks = round(seq(-5, 5, by = 1),1)) +
  
  geom_vline(xintercept = 0, linetype = "dashed") +
  
  # Colour/shape settings
  scale_color_manual(values = c("#811D1C", "#153860"),
                     labels = c("Acquisition CS-", "Extinction CS+")) +
  scale_shape_manual(values = c(1, 16),
                     labels = c("p > 0.05", "p <= 0.05")) +
  scale_alpha_discrete(range = c(0.5, 1),
                       labels = c("Covariate", "Explanatory")) +
  
  # Labels
  scale_y_discrete(
    labels = c(
      "demographics_age_at_screening_years_z" = "Age",
      "demographics_biological_sexmale" = "Biological sex (male)",
      "ieso_treatment_completed_total_z" = "Number of treatment sessions",
      "gad7_treatment_total_1_z" = "First session GAD-7 score",
      "fc" = "Fear conditioning predictor"
    )
  ) +
  labs(
    caption = paste0("Intercepts",
      "\nModel 1 = ",
      round(sec_acq_minus_model1$coefficients[1], digits = 2),
      "\nModel 2 = ",
      round(sec_ext_plus_model1$coefficients[1], digits = 2)
    ),
    x = "Standardised beta coefficients",
    y = element_blank(),
    shape = "Significance",
    color = "Model",
    alpha = "Variable type"
  ) +
  
  # Theme
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.text.x = element_blank(),
    plot.caption = element_text(hjust = 0),
    plot.title = element_text(size=11),
    plot.subtitle = element_text(size=10),
    legend.title=element_text(size=9),
    legend.text=element_text(size=8)
  )

ggsave(here("reports", "figures", "secondary1-regression-forest-plot.png"),
  bg = "white")
```

### GAD-7 at follow-up (DV)
The second set of secondary analyses repeats the same models as the primary 
analyses, except GAD-7 scores from follow-up are used as the outcome variable
instead of GAD-7 scores from participants' final treatment session.

#### Acquisition CS-

```{r secondary followup gad acq}
# Generate model
sec_acq_minus_model2 <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_followup_total ~ 
      exp_acquisition_cs_minus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(sec_acq_minus_model2)

# Save single row summary of model
sec_acq_minus_model_glance2 <- 
  glance(sec_acq_minus_model2)

# Save summary dataframe of test results
sec_acq_minus_model_tidy2 <- 
  tidy(sec_acq_minus_model2, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 4)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - gad7 followup dv", 
         model = "acquisition_cs_minus", 
         .before = everything())
```

#### Extinction CS+

```{r secondary followup gad ext}
# Generate model
sec_ext_plus_model2 <- 
  port_data_exclusions_applied_std %>%
  lm(
    gad7_followup_total ~ 
      exp_extinction_cs_plus_mean_z + 
      gad7_treatment_total_1_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(sec_ext_plus_model2)

# Save single row summary of model
sec_ext_plus_model_glance2 <- 
  glance(sec_ext_plus_model2)

# Save summary dataframe of test results
sec_ext_plus_model_tidy2 <- 
  tidy(sec_ext_plus_model2, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 4)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - gad7 followup dv", 
         model = "extinction_cs_plus", 
         .before = everything())
```

#### Plot

```{r secondary followup gad combine dataframes}
secondary_models_tidy2 <- rbind(sec_acq_minus_model_tidy2, sec_ext_plus_model_tidy2) %>% 
  mutate(sig_05 = if_else(p.value <= 0.05, TRUE, FALSE),
         sig_05_adj = if_else(pval.adj <= 0.05, TRUE, FALSE),
         term = factor(if_else(str_detect(term, "exp_"), "fc", term)),
         iv = case_when(
           term == "gad7_treatment_total_1_z" ~ FALSE,
           term == "ieso_treatment_completed_total_z" ~ FALSE,
           TRUE ~ TRUE),
         term = fct_rev(term))
```

```{r secondary followup gad plot}
secondary_models_tidy2 %>%
  filter(term != "(Intercept)") %>%
  
  # Plot
  ggplot(aes(
    x = estimate,
    y = term,
    group = fct_rev(model),
    colour = model,
    alpha = iv
  )) +
  geom_point(aes(shape = sig_05_adj),
             size = 2,
             position = position_dodge(width = .3)) +
  
  geom_errorbar(
    aes(xmin = conf.low, xmax = conf.high),
    position = position_dodge(width = .3),
    width = 0
  ) +
  
  scale_x_continuous(limits = c(-5, 5), breaks = round(seq(-5, 5, by = 1),1)) +
  
  geom_vline(xintercept = 0, linetype = "dashed") +
  
  # Colour/shape settings
  scale_color_manual(values = c("#811D1C", "#153860"),
                     labels = c("Acquisition CS-", "Extinction CS+")) +
  scale_shape_manual(values = c(1, 16),
                     labels = c("p > 0.05", "p <= 0.05")) +
  scale_alpha_discrete(range = c(0.5, 1),
                       labels = c("Covariate", "Explanatory")) +
  
  # Labels
  scale_y_discrete(
    labels = c(
      "ieso_treatment_completed_total_z" = "Number of treatment sessions",
      "gad7_treatment_total_1_z" = "First session GAD-7 score",
      "fc" = "Fear conditioning predictor"
    )
  ) +
  labs(
    caption = paste0("Intercepts",
      "\nModel 1 = ",
      round(sec_acq_minus_model2$coefficients[1], digits = 2),
      "\nModel 2 = ",
      round(sec_ext_plus_model2$coefficients[1], digits = 2)
    ),
    x = "Standardised beta coefficients",
    y = element_blank(),
    shape = "Significance",
    color = "Model",
    alpha = "Variable type"
  ) +
  
  # Theme
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.text.x = element_blank(),
    plot.caption = element_text(hjust = 0),
    plot.title = element_text(size=11),
    plot.subtitle = element_text(size=10),
    legend.title=element_text(size=9),
    legend.text=element_text(size=8)
  )

ggsave(here("reports", "figures", "secondary2-regression-forest-plot.png"),
  bg = "white")
```

### FSS scores at follow-up
The third set of secondary analyses repeats the same models as the primary 
analyses, except FSS scores from follow-up are used as the outcome variable
instead of GAD-7 scores from participants' final treatment session and FSS
scores at baseline are controlled for instead of first treatment session GAD-7 
scores.

#### Acquisition CS-

```{r secondary fss acq}
# Generate model
sec_acq_minus_model3 <- 
  port_data_exclusions_applied_std %>%
  lm(
    fss_followup_total ~ 
      exp_acquisition_cs_minus_mean_z + 
      fss_baseline_total_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(sec_acq_minus_model3)

# Save single row summary of model
sec_acq_minus_model_glance3 <- 
  glance(sec_acq_minus_model3)

# Save summary dataframe of test results
sec_acq_minus_model_tidy3 <- 
  tidy(sec_acq_minus_model3, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 4)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - fss followup dv", 
         model = "acquisition_cs_minus", 
         .before = everything())
```

#### Extinction CS+

```{r secondary fss ext}
# Generate model
sec_ext_plus_model3 <- 
  port_data_exclusions_applied_std %>%
  lm(
    fss_followup_total ~ 
      exp_extinction_cs_plus_mean_z + 
      fss_baseline_total_z + 
      ieso_treatment_completed_total_z,
    data = .
  )

# Model output
summary(sec_ext_plus_model3)

# Save single row summary of model
sec_ext_plus_model_glance3 <- 
  glance(sec_ext_plus_model3)

# Save summary dataframe of test results
sec_ext_plus_model_tidy3 <- 
  tidy(sec_ext_plus_model3, conf.int = T) %>% 
  # Add column of adjusted p-values (holm correction)
  mutate(pval.adj = p.adjust(p.value, method = "holm", n = 4)) %>% 
  # Add column describing model for later merge
  mutate(analysis = "secondary - fss followup dv", 
         model = "extinction_cs_plus", 
         .before = everything())
```

#### Plot

```{r secondary fss combine dataframes}
secondary_models_tidy3 <- rbind(sec_acq_minus_model_tidy3, sec_ext_plus_model_tidy3) %>% 
  mutate(sig_05 = if_else(p.value <= 0.05, TRUE, FALSE),
         sig_05_adj = if_else(pval.adj <= 0.05, TRUE, FALSE),
         term = factor(if_else(str_detect(term, "exp_"), "fc", term)),
         iv = case_when(
           term == "fss_baseline_total_z" ~ FALSE,
           term == "ieso_treatment_completed_total_z" ~ FALSE,
           TRUE ~ TRUE),
         term = fct_rev(term))

secondary_models_tidy3
```

```{r secondary fss plot}
secondary_models_tidy3 %>%
  filter(term != "(Intercept)") %>%
  
  # Plot
  ggplot(aes(
    x = estimate,
    y = term,
    group = fct_rev(model),
    colour = model,
    alpha = iv
  )) +
  geom_point(aes(shape = sig_05_adj),
             size = 2,
             position = position_dodge(width = .3)) +
  
  geom_errorbar(
    aes(xmin = conf.low, xmax = conf.high),
    position = position_dodge(width = .3),
    width = 0
  ) +
  
  scale_x_continuous(limits = c(-25, 25), breaks = round(seq(-25, 25, by = 5),1)) +
  
  geom_vline(xintercept = 0, linetype = "dashed") +
  
  # Colour/shape settings
  scale_color_manual(values = c("#811D1C", "#153860"),
                     labels = c("Acquisition CS-", "Extinction CS+")) +
  scale_shape_manual(values = c(1, 16),
                     labels = c("p > 0.05", "p <= 0.05")) +
  scale_alpha_discrete(range = c(0.5, 1),
                       labels = c("Covariate", "Explanatory")) +
  
  # Labels
  scale_y_discrete(
    labels = c(
      "ieso_treatment_completed_total_z" = "Number of treatment sessions",
      "fss_baseline_total_z" = "Pre-treatment FSS score",
      "fc" = "Fear conditioning predictor"
    )
  ) +
  labs(
    caption = paste0("Intercepts",
      "\nModel 1 = ",
      round(sec_acq_minus_model2$coefficients[1], digits = 2),
      "\nModel 2 = ",
      round(sec_ext_plus_model2$coefficients[1], digits = 2)
    ),
    x = "Standardised beta coefficients",
    y = element_blank(),
    shape = "Significance",
    color = "Model",
    alpha = "Variable type"
  ) +
  
  # Theme
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.text.x = element_blank(),
    plot.caption = element_text(hjust = 0),
    plot.title = element_text(size=11),
    plot.subtitle = element_text(size=10),
    legend.title=element_text(size=9),
    legend.text=element_text(size=8)
  )

ggsave(here("reports", "figures", "secondary3-regression-forest-plot.png"),
  bg = "white")
```

## Exploratory

### Discrimination scores (IV)

### Affective ratings (IV)

### Non-fear conditioning (IVs)

### Depression (covariate)

### Low GAD-7 excluded

### Non-completers excluded

## Save outputs

```{r save regression tables}
regression_model_coefficients <- rbind(
  primary_models_tidy,
  secondary_models_tidy1,
  secondary_models_tidy2,
  secondary_models_tidy3
)

regression_model_fits <- rbind(
  pri_acq_minus_model_glance,
  pri_ext_plus_model_glance,
  sec_acq_minus_model_glance1,
  sec_ext_plus_model_glance1,
  sec_acq_minus_model_glance2,
  sec_ext_plus_model_glance2,
  sec_acq_minus_model_glance3,
  sec_ext_plus_model_glance3
) %>%
  mutate(
    analysis = c(
      "primary",
      "primary",
      "secondary - age and sex adjustment",
      "secondary - age and sex adjustment",
      "secondary - gad7 followup dv",
      "secondary - gad7 followup dv",
      "secondary - fss followup dv",
      "secondary - fss followup dv"
    ),
    model = c(
      "acquisition_cs_minus",
      "extinction_cs_plus",
      "acquisition_cs_minus",
      "extinction_cs_plus",
      "acquisition_cs_minus",
      "extinction_cs_plus",
      "acquisition_cs_minus",
      "extinction_cs_plus"
    ),
    .before = everything()
  )

write_csv(
  regression_model_coefficients,
  here("reports", "tables", "regression_model_coefficients.csv")
)
write_csv(regression_model_fits,
          here("reports", "tables", "regression_model_fits.csv"))
```

# Visualisation

## Elephant

```{r elephant wrangling, include=FALSE}
# Create a list of expectancy rating trial variables
elephant_long <- port_data_exclusions_applied %>% 
  select(matches("^exp_.*\\d$")) %>%
  mutate(n = nrow(.)) %>% 
  pivot_longer(cols = -n, names_to = "variable", values_to = "rating") %>% 
  mutate(variable = str_remove(variable, "exp_")) %>%
  separate(variable, into = c("phase", "cs", "stimulus", "trial"), sep = "_") %>% 
  select(-cs) %>% 
  mutate(trial = as.numeric(trial)) %>% 
  group_by(phase, stimulus, trial) %>% 
  summarise(mean = mean(rating, na.rm = T), std_dev = sd(rating, na.rm = T), n = mean(n), .groups = "keep") %>% 
  mutate(sem = std_dev / sqrt(n),
         ci_low = mean - 2*(sem),
         ci_high = mean + 2*(sem)) %>% 
  ungroup() %>% 
  mutate(Phase = str_to_sentence(phase),
         Phase = factor(Phase, levels = c("Acquisition", "Extinction")),
         Stimulus = factor(stimulus, levels = c("plus", "minus")),
         Stimulus = fct_recode(Stimulus, "CS+" = "plus", "CS-" = "minus")) %>% 
  select(Phase, Stimulus, Trial = trial, everything()) %>% 
  select(-c(phase, stimulus)) %>% 
  arrange(Phase, Stimulus, Trial)

# Function for breaks
breaks_fun <- function(x) {
  if (max(x) > 12) {
    seq(0, 18, 1)
  } else {
    seq(0, 12, 1)
  }
}
```

```{r elephant plot}
elephant_plot_exclusions_applied <- elephant_long %>% 
  ggplot(aes(x = Trial, y = mean, color = Stimulus)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = ci_low, ymax = ci_high, fill = Stimulus),
              linetype = 0,
              alpha = 0.3,
              size = 0.8
  ) +
  scale_fill_manual(values = c("#811D1C", "#153860")) +
  scale_colour_manual(values = c("#811D1C", "#153860")) +
  facet_grid(~ Phase, 
               scales = "free_x",
               space = "free_x"
    ) +
    # adjust the labels
    labs(y="Mean expectancy rating", 
         x = "Trials"
    ) +
    theme(strip.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.position = 'bottom',
          text = element_text(size = 10),
          strip.text.x = element_text(size = 10)
    ) +
    scale_x_continuous(breaks = breaks_fun) +
    scale_y_continuous(breaks = seq(0, 10, by = 1), limits = c(1, 9))

elephant_plot_exclusions_applied

# Save
ggsave(
  file = paste0(here("reports", "figures"), "/elephant-plot_exclusions-applied.png"), 
  plot = elephant_plot_exclusions_applied, 
  width = 16, 
  height = 8, 
  units = "cm",
  bg = "white"
  )
```
